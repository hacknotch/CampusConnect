rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Default: authenticated users can read; writes are explicitly scoped below
    match /{document=**} {
      allow read: if isSignedIn();
    }

    // Student profiles
    match /students/{userId} {
      allow read: if isSignedIn();
      // Students can create their own document
      allow create: if isSignedIn() && request.auth.uid == userId;
      // Students can update their own document OR allow limited moderation fields
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'approved','approvedAt','approvedBy','verified','verifiedAt','verifiedBy'
        ])
      );
      // Do not allow deletes from clients
      allow delete: if false;
    }

    // Placement drives (created by manager; students read-only)
    match /placementDrives/{driveId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    // Applications (student creates; manager updates status)
    match /applications/{appId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isSignedIn() && (
        // Student can update their own application
        resource.data.studentId == request.auth.uid ||
        // Or anyone authenticated can only update workflow fields
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','updatedAt','updatedBy'])
      );
      allow delete: if isSignedIn() && resource.data.studentId == request.auth.uid;
    }

    // Saved jobs (owned by student)
    match /savedJobs/{savedId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.studentId == request.auth.uid;
    }

    // HOD requests (students create; HOD moderates status)
    match /hodRequests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      // Allow only status-related field changes from clients
      allow update: if isSignedIn() && request.resource.data.diff(resource.data).changedKeys().hasOnly([
        'status','approvedAt','approvedBy','rejectedAt','rejectedBy'
      ]);
      allow delete: if false;
    }
  }
}
